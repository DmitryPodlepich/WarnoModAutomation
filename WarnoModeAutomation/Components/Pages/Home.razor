@page "/"
@using System.Text
@using System.Diagnostics
@using WarnoModeAutomation.Logic;
@using BlazorBootstrap;
@using Microsoft.JSInterop
@inject IJSRuntime JS

<section class="d-flex flex-column h-100">

    <ConfirmDialog @ref="dialog" />

    <div>
        <Accordion AlwaysOpen="true">
            <AccordionItem Title="Status" IsActive="true">
                <Content>
                    <div class="d-flex flex-column">
                        <p class="h5">
                            <span class="badge badge-secondary">Mod name:</span>
                            <strong><small>@Storage.ModeSettings.ModName</small></strong>
                        </p>

                        <hr />

                        <p class="h5">
                            <span class="badge badge-secondary">Status:</span>
                            <strong><small>@Storage.Status.Status</small></strong>
                        </p>

                        <hr />

                    </div>
                </Content>
            </AccordionItem>
            <AccordionItem Title="Control" IsActive="true">
                <Content>
                    <div class="d-flex flex-row">
                        <Button Loading="@(_currentOperation == OperationType.Creation)" LoadingText="Creating..." Disabled="@(_currentOperation != OperationType.Idle)" Class="btn btn-primary" @onclick="CreateMod">
                            <i class="bi bi-plus-circle-dotted"></i> 
                            Create 
                        </Button>

                        <hr>

                        <Button Loading="@(_currentOperation == OperationType.Generation)" LoadingText="Generating..." Disabled="@(_currentOperation != OperationType.Idle)" Class="btn btn-primary ms-2" @onclick="GenerateMod">
                            <i class="bi bi-box-seam"></i>
                            Generate
                        </Button>

                        <hr>

                        <Button Loading="@(_currentOperation == OperationType.Updation)" LoadingText="Updating..." Disabled="@(_currentOperation != OperationType.Idle)" Class="btn btn-primary ms-2" @onclick="UpdateMod">
                            <i class="bi bi-download"></i>
                            Update 
                        </Button>

                        <hr>

                        <Button Loading="@(_currentOperation == OperationType.Modify)" LoadingText="Modifying..." Disabled="@(_currentOperation != OperationType.Idle)" Class="btn btn-primary ms-2" @onclick="Modify">
                            <i class="bi bi-cpu"></i>
                            Modify
                        </Button>

                        <hr>

                        <Button Loading="@(_currentOperation == OperationType.Deletion)" LoadingText="Deleting..." Disabled="@(_currentOperation != OperationType.Idle)" Class="btn btn-danger ms-2" @onclick="ShowDeleteModConfirmationAsync">
                            <i class="bi bi-trash-fill"></i>
                            Delete
                        </Button>

                    </div>

                    <div class="mt-3" >
                        <Switch @bind-Value="_enableFullLog" Label="Enable full log" />

                        <p class="text-muted"> If enabled will show detailed logs in a log text area below. Otherwise will show only warnings and errors. </p>
                    </div>

                </Content>
            </AccordionItem>
        </Accordion>
    </div>

    <div class="flex-grow-1 d-flex flex-column p-3">

        <div class="d-flex flex-row justify-content-between align-items-center mb-2">
            <p class="m-0"><strong>Mod manager log: </strong></p>
            <Button @onclick="ModManagerOutputClear" Class="btn btn-warning"><i class="bi bi-eraser-fill"></i> Clear</Button>
        </div>

        <InputTextArea @ref=textAreaRef class="flex-grow-1" style="font-size: 14px;" @bind-Value="@ModManagerOutput"></InputTextArea>
    </div>

</section>

@code {

    private ConfirmDialog dialog = default!;
    private InputTextArea textAreaRef;

    private enum OperationType
    {
        Idle,
        Creation,
        Deletion,
        Generation,
        Updation,
        Modify,
        FillDatabase
    }

    private bool _enableFullLog = false;
    private OperationType _currentOperation = OperationType.Idle;

    private string ModManagerOutput { get => _stringBuilder.ToString(); set => _stringBuilder = new StringBuilder(value); }
    private StringBuilder _stringBuilder;

    protected override Task OnInitializedAsync()
    {
        _stringBuilder = new StringBuilder();
        ModManager.OnOutput += ModManagerOnOutput;

        return base.OnInitializedAsync();
    }

    public void ModManagerOutputClear()
    {
        _stringBuilder.Clear();
    }

    public void ModManagerOnOutput(string data)
    {
        App.Current.Dispatcher.Dispatch(async () =>
        {
            _stringBuilder.AppendLine(Environment.NewLine);
            _stringBuilder.AppendLine(data);
            StateHasChanged();

            await JS.InvokeVoidAsync("scrollHeight", textAreaRef?.Element);
        });
    }

    public async Task CreateMod()
    {
        await Perform(OperationType.Creation, async () =>
        {
            await ModManager.CreateModAsync();
            Storage.Status.GetStatus();
        });
    }

    private async Task ShowDeleteModConfirmationAsync()
    {
        var options = new ConfirmDialogOptions
            {
                YesButtonText = "Ok",
                YesButtonColor = ButtonColor.Danger,
                NoButtonText = "Cancel",
                NoButtonColor = ButtonColor.Secondary
            };

        var confirmation = await dialog.ShowAsync(
            title: "Are you sure you want to delete current mod?",
            message1: "This will delete the mod. Once deleted can not be rolled back.",
            message2: "Do you want to proceed?",
            options);

        if (confirmation)
            await DeleteMod();
    }

    public async Task DeleteMod()
    {
        await Perform(OperationType.Deletion, async () =>
        {
            ModManager.DeleteMod();
            Storage.Status.GetStatus();
            await Task.CompletedTask;
        });
    }

    public async Task GenerateMod()
    {
        await Perform(OperationType.Generation, async () => 
        {
            await ModManager.GenerateModAsync();
            Storage.Status.GetStatus();
        });
    }

    public async Task UpdateMod()
    {
        await Perform(OperationType.Updation, async () =>
        {
            await ModManager.UpdateModAsync();
            Storage.Status.GetStatus();
        });
    }

    public async Task Modify()
    {
        await Perform(OperationType.Modify, async () => await ModManager.Modify(_enableFullLog));

    }

    public async Task FillDatabase()
    {
        await Perform(OperationType.FillDatabase, async () =>
        {
            var tokenSource = new CancellationTokenSource();

            await ModManager.FillDatabaseAsync(tokenSource);

        });
    }

    private async Task Perform(OperationType operationType, Func<Task> action)
    {
        _currentOperation = operationType;

        var stopwatch = new Stopwatch();

        stopwatch.Start();

        try
        {
            await action();
        }
        catch (Exception ex)
        {
            ModManagerOnOutput(ex.Message);
        }

        stopwatch.Stop();
        ModManagerOnOutput($"{operationType} finished! time: {stopwatch.ElapsedMilliseconds}");
        _currentOperation = OperationType.Idle;
    }
}